<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#050b14">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"> 
    <title>Tifor Admin - Ghost Protocol V18</title>
    
    <link rel="manifest" id="manifest-placeholder">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Hind+Siliguri:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        var bcrypt = window.dcodeIO ? window.dcodeIO.bcrypt : window.bcrypt;

        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Rajdhani', 'sans-serif'], bangla: ['Hind Siliguri', 'sans-serif'] },
                    colors: { cyber: '#00f3ff', void: '#020617', danger: '#ff0f39', success: '#10b981', warning: '#eab308' },
                    animation: { 'bounce-short': 'bounce 1s infinite 2', 'ping-slow': 'ping 2s cubic-bezier(0, 0, 0.2, 1) infinite' }
                }
            }
        }
        
        const API_URL = "https://script.google.com/macros/s/AKfycbw-oqETI8pdpmwQJYDbEYxxNrDisHC2dg6dx8N0TWpWg-5CSEQpL2sDEXKYg_2ixaCpKw/exec";
        
        const VALID_PIN_B64 = "NTA0OTY3"; 
        const ADMIN_PIN_HASH = "$2a$10$Nm8h.w./exampleHashPlaceHolder..."; 
        const MAX_ATTEMPTS = 3; 
        const BLOCK_TIME_MIN = 10; 
        const SESSION_TIMEOUT_MIN = 15; 
        
        const notifSound = new Audio("https://www.myinstants.com/media/sounds/super-mario-coin-sound.mp3");
    </script>

    <style>
        :root {
            --bg-color: #050b14; --text-main: #e2e8f0; --text-sub: #94a3b8;
            --glass-bg: rgba(30, 41, 59, 0.6); --glass-border: rgba(255, 255, 255, 0.08);
            --card-bg: rgba(15, 23, 42, 0.6); --header-bg: rgba(15, 23, 42, 0.95);
            --input-bg: rgba(2, 6, 23, 0.6); --input-border: #334155;
            --skeleton-base: #1e293b; --skeleton-highlight: #334155;
        }
        [data-theme="light"] {
            --bg-color: #f1f5f9; --text-main: #0f172a; --text-sub: #475569;
            --glass-bg: rgba(255, 255, 255, 0.7); --glass-border: rgba(0, 0, 0, 0.1);
            --card-bg: rgba(255, 255, 255, 0.8); --header-bg: rgba(255, 255, 255, 0.9);
            --input-bg: rgba(255, 255, 255, 0.9); --input-border: #cbd5e1;
            --skeleton-base: #e2e8f0; --skeleton-highlight: #f8fafc;
        }
        body { background: var(--bg-color); color: var(--text-main); font-family: 'Rajdhani', sans-serif; overflow-x: hidden; transition: background 0.5s ease, color 0.5s ease; }
        .glass { background: var(--glass-bg); backdrop-filter: blur(16px); border: 1px solid var(--glass-border); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); transition: all 0.5s ease; }
        .glass-header { background: var(--header-bg); border-bottom: 1px solid var(--glass-border); transition: all 0.5s ease; }
        .card-active { background: rgba(0, 243, 255, 0.1) !important; border-color: #00f3ff !important; box-shadow: 0 0 15px rgba(0, 243, 255, 0.15); }
        .theme-text { color: var(--text-main); } .theme-subtext { color: var(--text-sub); }
        .theme-input { background: var(--input-bg) !important; border-color: var(--input-border) !important; color: var(--text-main) !important; }
        .status-pending { border-left: 4px solid #eab308; } .status-success { border-left: 4px solid #10b981; } .status-cancelled { border-left: 4px solid #ff0f39; opacity: 0.8; }
        
        .skeleton-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem; position: relative; overflow: hidden; }
        .skeleton-box { background-color: var(--skeleton-base); border-radius: 0.25rem; position: relative; overflow: hidden; }
        .skeleton-box::after { position: absolute; top: 0; right: 0; bottom: 0; left: 0; transform: translateX(-100%); background-image: linear-gradient(90deg, rgba(255, 255, 255, 0) 0, rgba(255, 255, 255, 0.1) 20%, rgba(255, 255, 255, 0.2) 60%, rgba(255, 255, 255, 0)); animation: shimmer 1.5s infinite; content: ''; }
        @keyframes shimmer { 100% { transform: translateX(100%); } }
        .modal-scroll::-webkit-scrollbar { width: 6px; } .modal-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .settings-section-title { color: #00f3ff; font-size: 12px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid rgba(0, 243, 255, 0.2); padding-bottom: 5px; margin-top: 15px; margin-bottom: 10px; grid-column: span 2; }
    </style>
</head>
<body class="antialiased selection:bg-cyber selection:text-black">

    <div id="loginScreen" class="fixed inset-0 z-50 flex items-center justify-center bg-[#020617]">
        <div class="glass p-8 rounded-2xl w-full max-w-sm text-center">
            <i class="fa-solid fa-user-shield text-4xl text-cyber mb-6 animate-pulse"></i>
            <h2 class="text-4xl font-bold text-white mb-2 tracking-[4px]">ADMIN<span class="text-cyber">.IO</span></h2>
            <form onsubmit="handleLogin(event)" class="space-y-5 mt-8">
                <input type="password" id="pinInput" placeholder="ENTER PIN" class="w-full bg-black/40 border border-slate-700 rounded-xl px-4 py-4 text-center text-2xl text-cyber focus:outline-none focus:border-cyber tracking-[8px] font-mono">
                <button type="submit" class="w-full bg-cyan-700 hover:bg-cyan-600 text-white font-bold py-4 rounded-xl transition-all tracking-widest text-sm">ACCESS</button>
            </form>
            <p id="loginError" class="text-danger text-sm mt-4 hidden font-bold animate-bounce text-center"></p>
        </div>
    </div>

    <div id="dashboard" class="hidden min-h-screen pb-24">
        <header class="glass-header sticky top-0 z-40 shadow-lg">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-server text-cyber text-lg"></i>
                    <div>
                        <h1 class="text-xl font-bold theme-text tracking-widest">TIFOR<span class="text-slate-500">.ADMIN</span></h1>
                        <p class="text-[11px] theme-subtext font-mono tracking-wider" id="liveClock">--:--</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleWakeLock()" id="wakeLockBtn" class="w-9 h-9 bg-slate-500/10 text-slate-500 rounded-lg border border-slate-500/20 flex items-center justify-center hover:bg-cyber hover:text-black transition-all shadow-lg" title="Keep Screen Awake (For Notifications)"><i class="fa-solid fa-eye-slash"></i></button>
                    <button id="installBtn" class="hidden w-9 h-9 bg-cyber/10 text-cyber rounded-lg border border-cyber/20 flex items-center justify-center hover:bg-cyber hover:text-black transition-all shadow-lg animate-pulse" title="Install App"><i class="fa-solid fa-download"></i></button>
                    <button onclick="toggleTheme()" id="themeBtn" class="w-9 h-9 bg-slate-500/10 text-slate-500 rounded-lg border border-slate-500/20 flex items-center justify-center hover:bg-slate-500 hover:text-white transition-all shadow-lg"><i class="fa-solid fa-moon"></i></button>
                    <button onclick="backupData()" class="w-9 h-9 bg-blue-500/10 text-blue-500 rounded-lg border border-blue-500/20 flex items-center justify-center hover:bg-blue-500 hover:text-white transition-all shadow-lg shadow-blue-500/20"><i class="fa-solid fa-cloud-arrow-down"></i></button>
                    <input type="file" id="restoreFile" accept=".json" class="hidden" onchange="restoreBackup(event)">
                    <button onclick="document.getElementById('restoreFile').click()" class="w-9 h-9 bg-purple-500/10 text-purple-500 rounded-lg border border-purple-500/20 flex items-center justify-center hover:bg-purple-500 hover:text-white transition-all shadow-lg shadow-purple-500/20"><i class="fa-solid fa-cloud-arrow-up"></i></button>
                    <button onclick="exportToExcel()" class="w-9 h-9 bg-emerald-500/10 text-emerald-500 rounded-lg border border-emerald-500/20 flex items-center justify-center hover:bg-emerald-500 hover:text-white transition-all shadow-lg shadow-emerald-500/20"><i class="fa-solid fa-file-excel"></i></button>
                    <button onclick="openSettings()" class="w-9 h-9 bg-cyan-500/10 text-cyber rounded-lg border border-cyan-500/20 flex items-center justify-center hover:bg-cyan-500 hover:text-white transition-all shadow-lg shadow-cyan-500/20"><i class="fa-solid fa-gear fa-spin-pulse" style="--fa-animation-duration: 3s;"></i></button>
                    <button onclick="logout()" class="w-9 h-9 bg-red-500/10 text-danger rounded-lg border border-danger/20 flex items-center justify-center hover:bg-danger hover:text-white transition-all"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-3 py-4 space-y-5">
            <div class="grid grid-cols-4 gap-2">
                <div onclick="filterStatus('All')" id="cardAll" class="glass p-3 rounded-xl cursor-pointer text-center border-b-2 border-slate-500 card-active"><p class="text-[10px] uppercase theme-subtext font-bold">Total</p><p class="text-2xl font-bold theme-text font-mono" id="statTotal">0</p></div>
                <div onclick="filterStatus('Pending')" id="cardPending" class="glass p-3 rounded-xl cursor-pointer text-center border-b-2 border-yellow-500"><p class="text-[10px] uppercase text-yellow-500 font-bold">Pending</p><p class="text-2xl font-bold text-yellow-400 font-mono" id="statPending">0</p></div>
                <div onclick="filterStatus('Success')" id="cardSuccess" class="glass p-3 rounded-xl cursor-pointer text-center border-b-2 border-emerald-500"><p class="text-[10px] uppercase text-emerald-500 font-bold">Done</p><p class="text-2xl font-bold text-emerald-400 font-mono" id="statSuccess">0</p></div>
                <div onclick="filterStatus('Cancelled')" id="cardCancelled" class="glass p-3 rounded-xl cursor-pointer text-center border-b-2 border-danger"><p class="text-[10px] uppercase text-danger font-bold">Fail</p><p class="text-2xl font-bold text-danger font-mono" id="statCancelled">0</p></div>
            </div>
            
            <div id="dateFilterBadge" class="flex justify-center -mb-2">
                 <span class="text-[10px] bg-slate-800 text-slate-400 px-3 py-1 rounded-full border border-slate-700 font-mono tracking-widest uppercase">
                    <i class="fa-regular fa-calendar-check text-cyan-500 mr-1"></i> <span id="displayDate">Loading...</span>
                 </span>
            </div>

            <div class="relative group">
                <input type="text" id="searchInput" oninput="handleSearch()" placeholder="Search TrxID (History)..." class="w-full theme-input rounded-xl pl-10 pr-10 py-3 focus:outline-none focus:border-cyber theme-text transition-all shadow-inner border">
                <button onclick="fetchData()" class="absolute right-3 top-3 theme-subtext hover:text-cyber transition-transform active:rotate-180"><i class="fa-solid fa-rotate" id="refreshIcon"></i></button>
            </div>

            <div id="orderList" class="space-y-4">
                <!-- Skeleton will be injected here via JS -->
            </div>
        </main>
        
        <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-full text-xs font-bold shadow-2xl border border-slate-600 transition-all opacity-0 translate-y-20 z-50 flex items-center gap-2">
            <i class="fa-solid fa-check-circle text-success"></i> <span id="toastMsg">Action Successful</span>
        </div>
    </div>

    <div id="actionModal" class="fixed inset-0 z-50 bg-black/95 hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass w-full max-w-sm rounded-2xl p-6 border border-danger/30 shadow-2xl">
            <h3 class="text-xl font-bold theme-text mb-4 border-b border-white/10 pb-3 flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation text-danger"></i> REJECT ORDER</h3>
            <textarea id="reasonInput" class="w-full theme-input rounded-xl p-4 theme-text text-sm h-24 mb-5 resize-none focus:border-danger outline-none border" placeholder="Write reason..."></textarea>
            <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 bg-slate-800 hover:bg-slate-700 text-white py-3 rounded-xl text-sm font-bold border border-slate-600">CANCEL</button>
                <button onclick="confirmReject()" class="flex-1 bg-danger hover:bg-red-600 text-white py-3 rounded-xl text-sm font-bold shadow-lg shadow-danger/20">CONFIRM</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 z-50 bg-black/95 hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass w-full max-w-lg rounded-2xl border border-cyan-500/30 shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-white/10 flex justify-between items-center bg-cyan-900/10">
                <h3 class="text-xl font-bold theme-text flex items-center gap-2"><i class="fa-solid fa-sliders text-cyber"></i> SETTINGS</h3>
                <button onclick="closeSettings()" class="theme-subtext hover:text-danger"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="p-5 overflow-y-auto modal-scroll space-y-4 flex-1">
                <div class="grid grid-cols-2 gap-3" id="settingsContainer">
                    <div class="col-span-2 text-center text-cyber animate-pulse py-10"><i class="fa-solid fa-circle-notch fa-spin text-2xl mb-2"></i><br>Connecting to Server...</div>
                </div>
            </div>

            <div class="p-5 border-t border-white/10 flex justify-end gap-3 bg-black/20">
                <button onclick="closeSettings()" class="px-6 py-2 rounded-lg bg-slate-800 text-slate-300 hover:text-white font-bold text-sm">Cancel</button>
                <button onclick="saveSettings()" id="btnSaveSettings" class="px-6 py-2 rounded-lg bg-cyber text-black hover:bg-cyan-400 font-bold text-sm shadow-lg shadow-cyan-500/20 flex items-center gap-2">
                    <i class="fa-solid fa-floppy-disk"></i> SAVE CHANGES
                </button>
            </div>
        </div>
    </div>

    <script>
        const manifest = {
            "name": "Tifor Admin",
            "short_name": "Tifor",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#050b14",
            "theme_color": "#050b14",
            "icons": [{ "src": "https://cdn-icons-png.flaticon.com/512/1827/1827301.png", "sizes": "192x192", "type": "image/png" }]
        };
        document.getElementById('manifest-placeholder').setAttribute('href', 'data:application/json;base64,' + btoa(JSON.stringify(manifest)));

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const btn = document.getElementById('installBtn');
            btn.classList.remove('hidden');
            btn.addEventListener('click', () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((result) => {
                    if (result.outcome === 'accepted') btn.classList.add('hidden');
                    deferredPrompt = null;
                });
            });
        });

        let wakeLock = null;
        async function toggleWakeLock() {
            const btn = document.getElementById('wakeLockBtn');
            if ('wakeLock' in navigator) {
                if(wakeLock === null) {
                    try {
                        wakeLock = await navigator.wakeLock.request('screen');
                        btn.innerHTML = '<i class="fa-solid fa-eye text-cyber"></i>';
                        btn.classList.add('bg-cyber/10', 'border-cyber/20');
                        btn.classList.remove('bg-slate-500/10', 'border-slate-500/20');
                        showToast("Screen Awake: ON (Strong Mode)");
                    } catch (err) { console.error(err); }
                } else {
                    wakeLock.release().then(() => {
                        wakeLock = null;
                        btn.innerHTML = '<i class="fa-solid fa-eye-slash"></i>';
                        btn.classList.remove('bg-cyber/10', 'border-cyber/20');
                        btn.classList.add('bg-slate-500/10', 'border-slate-500/20');
                        showToast("Screen Awake: OFF");
                    });
                }
            } else { alert("Wake Lock not supported"); }
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const btn = document.getElementById('themeBtn');
            if(theme === 'dark') {
                btn.innerHTML = '<i class="fa-solid fa-sun text-warning"></i>';
                btn.classList.add('bg-warning/10', 'border-warning/20');
                btn.classList.remove('bg-slate-500/10', 'border-slate-500/20');
            } else {
                btn.innerHTML = '<i class="fa-solid fa-moon text-slate-600"></i>';
                btn.classList.remove('bg-warning/10', 'border-warning/20');
                btn.classList.add('bg-slate-500/10', 'border-slate-500/20');
            }
        }

        const settingsConfig = [
            { title: "SHOP INFO", type: "header" },
            { id: "notice_text", label: "Scrolling Notice", full: true },
            { title: "AUTO WHATSAPP MESSAGE", type: "header" },
            { id: "wa_template", label: "Accept Template", full: true, type: "textarea" },
            { title: "LIVE RESERVE STOCK", type: "header" },
            { id: "reserveBDT", label: "BDT Reserve" },
            { id: "reserveUSDT", label: "USDT Reserve" },
            { title: "EXCHANGE RATES", type: "header" },
            { id: "rate_binance_buy", label: "Binance Sell" }, { id: "rate_binance_sell", label: "Binance Buy" },
            { id: "rate_bitget_buy", label: "Bitget Sell" }, { id: "rate_bitget_sell", label: "Bitget Buy" },
            { id: "rate_mexc_buy", label: "Mexc Sell" }, { id: "rate_mexc_sell", label: "Mexc Buy" },
            { id: "rate_redotpay_buy", label: "RedotPay Sell" }, { id: "rate_redotpay_sell", label: "RedotPay Buy" },
            { title: "WALLET ADDRESSES", type: "header" },
            { id: "binance_id", label: "Binance Pay ID" }, 
            { id: "bitget_id", label: "Bitget UID" },
            { id: "mexc_id", label: "Mexc UID" }, 
            { id: "redotpay_id", label: "RedotPay ID" },
            { id: "bkash", label: "Bkash Personal" }, 
            { id: "nagad", label: "Nagad Personal" },
            { id: "upay", label: "Upay Personal" },
            { id: "tallykhata", label: "TallyKhata Personal" },
            { id: "rocket", label: "Rocket" }, 
            { id: "rocket_extra", label: "Rocket Extra" }, 
            { id: "whatsapp", label: "WhatsApp" },
            { title: "SERVICE CHARGE SLABS", type: "header" },
            { id: "fee_slab_1", label: "Fee (10-50)" },
            { id: "fee_slab_2", label: "Fee (51-100)" },
            { id: "fee_slab_3", label: "Fee (101-300)" },
            { id: "fee_slab_4", label: "Fee (301-1000)" },
            { id: "fee_slab_5", label: "Fee (1001+)" }
        ];

        let allData = [];
        let viewStatus = 'All'; 
        let targetId = null; 
        let lastPendingCount = 0; 
        let pollingWorker; 
        let isFirstLoad = true; 
        
        // ðŸ”¥ GHOST PROTOCOL VARIABLES
        // Stores IDs that are deleted locally but might still be in server response
        let localDeletedIds = new Set();
        // Stores local modifications { trxId: { status, reason, timestamp } }
        let localModifiedItems = new Map();

        function formatTime12H(date) {
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true, timeZone: 'Asia/Dhaka' });
        }

        function getBDDateString(dateInput) {
            try {
                const d = dateInput ? new Date(dateInput) : new Date();
                if (isNaN(d.getTime())) return new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Dhaka' });
                return d.toLocaleDateString('en-CA', { timeZone: 'Asia/Dhaka' });
            } catch (e) {
                return new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Dhaka' });
            }
        }

        function reprocessData(data) {
            return data.map(item => ({
                ...item,
                bdDateStr: getBDDateString(item.timestamp) 
            }));
        }

        function sortData(data) {
            return data.sort((a, b) => {
                if (a.status === 'Pending' && b.status !== 'Pending') return -1;
                if (a.status !== 'Pending' && b.status === 'Pending') return 1;
                return new Date(b.timestamp) - new Date(a.timestamp);
            });
        }

        let inactivityTimer;
        function resetSessionTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(logout, SESSION_TIMEOUT_MIN * 60 * 1000);
        }

        const workerCode = `
            let intervalId;
            self.onmessage = function(e) {
                if (e.data.action === 'start') {
                    const apiUrl = e.data.url;
                    fetchData(apiUrl);
                    intervalId = setInterval(() => fetchData(apiUrl), 4000); // 4s polling
                } else if (e.data.action === 'stop') {
                    clearInterval(intervalId);
                }
            };
            async function fetchData(url) {
                try {
                    const res = await fetch(url + '?action=read&t=' + Date.now());
                    const data = await res.json();
                    self.postMessage({ status: 'success', data: data });
                } catch (err) {
                    self.postMessage({ status: 'error', error: err.message });
                }
            }
        `;

        window.onload = () => {
            initTheme();
            setInterval(() => document.getElementById('liveClock').innerText = formatTime12H(new Date()), 1000);
            
            const blob = new Blob([workerCode], { type: "application/javascript" });
            pollingWorker = new Worker(URL.createObjectURL(blob));
            
            pollingWorker.onmessage = function(e) {
                if (e.data.status === 'success') {
                    handleWorkerData(e.data.data);
                }
            };

            // Remove old storage
            localStorage.removeItem('admin_orders');

            if(sessionStorage.getItem('TIFOR_ADMIN') === 'GRANTED') {
                showDashboard();
                ['mousemove', 'keydown', 'click', 'scroll'].forEach(evt => document.addEventListener(evt, resetSessionTimer));
                resetSessionTimer();
            }
        };

        function handleLogin(e) { 
            e.preventDefault(); 
            const pin = document.getElementById('pinInput').value;
            const errorEl = document.getElementById('loginError');
            
            const blockUntil = localStorage.getItem('block_until');
            if(blockUntil && Date.now() < parseInt(blockUntil)) {
                errorEl.innerText = `LOCKED! TRY IN ${Math.ceil((parseInt(blockUntil) - Date.now()) / 60000)} MIN`;
                errorEl.classList.remove('hidden');
                return;
            }

            let isMatch = false;
            if(VALID_PIN_B64 && btoa(pin) === VALID_PIN_B64) isMatch = true;
            else if(ADMIN_PIN_HASH && ADMIN_PIN_HASH.startsWith('$2a$') && bcrypt && bcrypt.compareSync(pin, ADMIN_PIN_HASH)) isMatch = true;

            if(isMatch) { 
                localStorage.removeItem('login_attempts');
                localStorage.removeItem('block_until');
                sessionStorage.setItem('TIFOR_ADMIN', 'GRANTED'); 
                
                notifSound.play().catch(e=>{});
                
                if ("Notification" in window && Notification.permission !== "granted") Notification.requestPermission();
                showDashboard(); 
                resetSessionTimer();
            } else { 
                let attempts = parseInt(localStorage.getItem('login_attempts') || '0') + 1;
                localStorage.setItem('login_attempts', attempts);
                if(attempts >= MAX_ATTEMPTS) {
                    localStorage.setItem('block_until', Date.now() + (BLOCK_TIME_MIN * 60 * 1000));
                    errorEl.innerText = `BLOCKED FOR ${BLOCK_TIME_MIN} MIN.`;
                } else {
                    errorEl.innerText = `WRONG PIN!`;
                }
                errorEl.classList.remove('hidden'); 
            } 
        }
        
        function showDashboard() { 
            document.getElementById('loginScreen').classList.add('hidden'); 
            document.getElementById('dashboard').classList.remove('hidden'); 
            fetchData(); 
        }
        
        function logout() { 
            if(pollingWorker) pollingWorker.postMessage({ action: 'stop' });
            sessionStorage.removeItem('TIFOR_ADMIN'); 
            location.reload(); 
        }

        function getSkeletonHTML() {
            return `<div class="skeleton-card"><div class="skeleton-box h-8 w-1/3 mb-4"></div><div class="skeleton-box h-24 w-full"></div></div>`.repeat(3);
        }

        function fetchData() {
            document.getElementById('refreshIcon').classList.add('fa-spin');
            if(document.getElementById('orderList').innerHTML.trim() === "") {
                document.getElementById('orderList').innerHTML = getSkeletonHTML();
            }
            if(pollingWorker) pollingWorker.postMessage({ action: 'start', url: API_URL });
        }

        function handleWorkerData(data) {
            document.getElementById('refreshIcon').classList.remove('fa-spin');
            
            if(Array.isArray(data)) { 
                // ðŸ”¥ GHOST PROTOCOL: FILTER & MERGE WITH LOCAL STATE
                let mergedData = data.filter(item => !localDeletedIds.has(item.trxId));
                
                // Apply local modifications if server hasn't updated yet
                mergedData = mergedData.map(item => {
                    if (localModifiedItems.has(item.trxId)) {
                        const localItem = localModifiedItems.get(item.trxId);
                        // If server matches local status, remove from local override (sync complete)
                        if (item.status === localItem.status) {
                            localModifiedItems.delete(item.trxId);
                            return item;
                        } else {
                            // Server is old, override with local
                            return { ...item, status: localItem.status, reason: localItem.reason || item.reason };
                        }
                    }
                    return item;
                });

                // Also clean up localDeletedIds if server no longer has them
                // (Server caught up with delete)
                const serverIds = new Set(data.map(i => i.trxId));
                localDeletedIds.forEach(id => {
                    if (!serverIds.has(id)) {
                        localDeletedIds.delete(id);
                    }
                });

                mergedData = sortData(mergedData);
                const processedData = reprocessData(mergedData);
                
                allData = processedData; 
                
                const currentPending = allData.filter(i => i.status === 'Pending').length;
                
                if(isFirstLoad) {
                    lastPendingCount = currentPending;
                    isFirstLoad = false;
                    renderView();
                    return; 
                }

                if(currentPending > lastPendingCount) {
                    const latest = allData.find(i => i.status === 'Pending');
                    
                    notifSound.play().catch(e=>{});
                    
                    if(Notification.permission === "granted" && latest) {
                        new Notification("ðŸ”¥ NEW ORDER ALERT! (Tifor)", { 
                            body: `${latest.amountReceived} Tk - ${latest.platform}\nTrx: ${latest.trxId}`,
                            icon: "https://cdn-icons-png.flaticon.com/512/1827/1827301.png",
                            requireInteraction: true, 
                            vibrate: [200, 100, 200, 100, 200]
                        });
                    }
                    showToast(`ðŸ”” New Order! Pending: ${currentPending}`);
                }
                lastPendingCount = currentPending;
                renderView(); 
            }
        }

        function renderView() {
            const search = document.getElementById('searchInput').value.toLowerCase().trim();
            const todayDateStr = getBDDateString(); 
            const isSearching = search.length > 0;
            
            document.getElementById('displayDate').innerText = isSearching ? "Global Search" : `${todayDateStr} + Pending`;

            let list = allData.filter(i => {
                const matchesStatus = (viewStatus === 'All' || i.status === viewStatus);
                const matchesSearch = search === '' || 
                    (i.trxId && i.trxId.toLowerCase().includes(search)) ||
                    (i.userIdentifier && i.userIdentifier.toLowerCase().includes(search)) ||
                    (i.contact && i.contact.includes(search));
                
                const isToday = i.bdDateStr === todayDateStr;
                const isPending = i.status === 'Pending';

                if (isSearching) return matchesStatus && matchesSearch; 
                else return matchesStatus && (isToday || isPending); 
            });

            let statsBase = isSearching 
                ? list 
                : allData.filter(i => i.bdDateStr === todayDateStr || i.status === 'Pending');

            document.getElementById('statTotal').innerText = statsBase.length;
            document.getElementById('statPending').innerText = allData.filter(i => i.status === 'Pending').length; 
            document.getElementById('statSuccess').innerText = statsBase.filter(i => ['Success','Completed'].includes(i.status)).length;
            document.getElementById('statCancelled').innerText = statsBase.filter(i => i.status === 'Cancelled').length;

            const container = document.getElementById('orderList');
            if(list.length === 0) { 
                container.innerHTML = `<div class="text-center py-20 opacity-40 theme-subtext font-mono tracking-widest"><i class="fa-solid fa-magnifying-glass mb-3 text-2xl"></i><br>${isSearching?"NO MATCH IN HISTORY":"NO ORDERS TODAY"}</div>`; 
                return; 
            }
            
            container.innerHTML = list.map(item => `
                <div class="glass rounded-xl overflow-hidden mb-4 ${item.status === 'Pending' ? 'status-pending' : (item.status === 'Cancelled' ? 'status-cancelled' : 'status-success')} group transition-all hover:-translate-y-1">
                    <div class="bg-slate-900/10 p-3 flex justify-between items-center border-b border-white/5">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-cyan-500">${(item.platform || 'Unknown').split(' To ')[0]}</span>
                            <i class="fa-solid fa-arrow-right theme-subtext text-xs"></i>
                            <span class="font-bold text-warning">${(item.platform || 'Unknown').split(' To ')[1]}</span>
                        </div>
                        <div class="flex flex-col items-end">
                            <span class="text-[10px] font-mono theme-subtext bg-black/10 px-2 py-1 rounded">${item.timestamp}</span>
                            ${item.bdDateStr !== todayDateStr ? `<span class="text-[9px] text-red-400 font-bold mt-1">OLD DATA</span>` : ''}
                        </div>
                    </div>
                    <div class="p-3 space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-black/5 p-2 rounded border border-white/5">
                                <div class="text-[10px] theme-subtext font-bold uppercase">IN</div>
                                <div class="theme-text font-bold text-lg">${item.amountReceived}</div>
                                <div class="text-xs theme-subtext font-mono mt-1 flex items-center gap-1"><i class="fa-solid fa-user-tag text-[10px]"></i> ${item.userIdentifier}</div>
                            </div>
                            <div class="bg-cyan-900/10 p-2 rounded border border-cyan-500/20 relative">
                                <div class="text-[10px] text-cyan-600 font-bold uppercase">TrxID</div>
                                <div class="theme-text font-mono font-bold text-lg tracking-wide">${item.trxId}</div>
                                <button onclick="copy('${item.trxId}')" class="absolute top-2 right-2 text-cyan-600 p-1"><i class="fa-regular fa-copy"></i></button>
                            </div>
                        </div>
                        <div class="bg-emerald-900/10 p-2 rounded border border-emerald-500/20 relative">
                            <div class="text-[10px] text-emerald-600 font-bold uppercase">OUT</div>
                            <div class="text-emerald-500 font-bold text-2xl font-mono">${item.amountSent}</div>
                            <button onclick="copy('${item.amountSent}')" class="absolute top-1/2 -translate-y-1/2 right-3 text-emerald-600 w-8 h-8 flex items-center justify-center rounded"><i class="fa-regular fa-copy"></i></button>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center bg-black/5 p-2 rounded border border-white/5">
                                <div class="overflow-hidden mr-2"><span class="text-[10px] theme-subtext block uppercase font-bold">Receiver</span><span class="theme-text font-mono text-sm truncate block">${item.receiverDetails}</span></div>
                                <button onclick="copy('${item.receiverDetails}')" class="theme-subtext hover:text-white p-1.5"><i class="fa-regular fa-copy"></i></button>
                            </div>
                            <div class="flex justify-between items-center bg-black/5 p-2 rounded border border-white/5">
                                <div class="overflow-hidden mr-2"><span class="text-[10px] theme-subtext block uppercase font-bold">Contact</span><span class="text-green-500 font-mono text-sm truncate block">${item.contact}</span></div>
                                <button onclick="copy('${item.contact}')" class="text-green-500 hover:text-white p-1.5"><i class="fa-regular fa-copy"></i></button>
                            </div>
                        </div>
                        ${item.status === 'Cancelled' ? `<div class="bg-red-500/10 border border-red-500/20 rounded p-3 text-xs text-red-500"><span class="font-bold mr-1 block mb-1 text-red-600">REASON:</span> ${item.reason}</div>` : ''}
                    </div>
                    <div class="p-3 bg-black/5 border-t border-white/5 flex gap-2">
                        ${item.status === 'Pending' ? `
                        <button onclick="performAction('${item.trxId}','Success', '', '${item.contact}', '${item.amountSent}')" class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-lg text-sm font-bold uppercase transition-all shadow-lg flex justify-center items-center gap-2"><i class="fa-solid fa-check"></i> Accept</button>
                        <button onclick="openModal('${item.trxId}')" class="flex-1 bg-red-600 hover:bg-red-500 text-white py-3 rounded-lg text-sm font-bold uppercase transition-all shadow-lg flex justify-center items-center gap-2"><i class="fa-solid fa-ban"></i> Reject</button>
                        <button onclick="performAction('${item.trxId}','delete')" class="w-10 bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white rounded-lg border border-slate-700 transition-all"><i class="fa-solid fa-trash"></i></button>
                        ` : `
                        <div class="flex-1 bg-black/5 border border-white/5 rounded-lg py-2 flex justify-center items-center">
                            ${item.status === 'Cancelled' ? `<span class="text-danger font-bold text-sm flex items-center gap-2"><i class="fa-solid fa-ban"></i> REJECTED</span>` : `<span class="text-emerald-500 font-bold text-sm flex items-center gap-2"><i class="fa-solid fa-check-circle"></i> COMPLETED</span>`}
                        </div>
                        <button onclick="performAction('${item.trxId}','delete')" class="w-10 bg-slate-800 hover:bg-red-900/50 text-slate-500 hover:text-red-400 rounded-lg border border-slate-700 transition-all"><i class="fa-solid fa-trash"></i></button>
                        `}
                    </div>
                </div>
            `).join('');
            ['All','Pending','Success','Cancelled'].forEach(s => document.getElementById(`card${s}`).classList.toggle('card-active', viewStatus === s));
        }

        async function performAction(id, type, reason='', contact='', amount='') {
            if(type === 'delete' && !confirm("Delete Permanently?")) return;
            
            // ðŸ”¥ GHOST PROTOCOL ACTIVATED: INSTANT UPDATE & BLACKLIST
            if(type==='delete') {
                localDeletedIds.add(id);
                allData = allData.filter(i => i.trxId !== id);
            } else {
                localModifiedItems.set(id, { status: type, reason: reason });
                allData = allData.map(i => i.trxId === id ? {...i, status:type, reason:reason} : i);
            }
            
            // Immediate Resort & Render
            allData = sortData(allData); 
            renderView(); 

            // Handle WhatsApp
            if(type === 'Success' && contact) {
                const cachedSettings = JSON.parse(localStorage.getItem('admin_settings') || '{}');
                let template = cachedSettings.wa_template || "Order {trx} Completed! Sent: {amount}. Thanks!";
                let cleanContact = contact.replace(/[^0-9]/g, '');
                if(cleanContact.startsWith('01')) cleanContact = '88' + cleanContact;
                let msg = template.replace('{trx}', id).replace('{amount}', amount);
                window.open(`https://wa.me/${cleanContact}?text=${encodeURIComponent(msg)}`, '_blank');
            }

            // Sync with Server (Optimistic)
            try {
                await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: type==='delete'?'delete':'update', trxId: id, status: type, reason: reason }) });
            } catch(e) { 
                alert("Request Failed (Check Internet)"); 
                // We keep local state as truth for now
            }
        }

        // Export, Backup, Restore, Settings functions remain unchanged...
        function exportToExcel() {
            if(!allData.length) { showToast("No Data!"); return; }
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(allData);
            XLSX.utils.book_append_sheet(wb, ws, "Orders");
            XLSX.writeFile(wb, `Tifor_Orders.xlsx`);
        }
        function backupData() {
            if(!allData.length) { showToast("No Data!"); return; }
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allData));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", `Backup.json`);
            document.body.appendChild(node); node.click(); node.remove();
        }
        function restoreBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    allData = JSON.parse(e.target.result);
                    renderView();
                    showToast("Restored!");
                } catch(err) { alert("Invalid File"); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        async function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('settingsModal').classList.add('flex');
            const cached = localStorage.getItem('admin_settings');
            if(cached) renderSettings(JSON.parse(cached));
            try {
                const res = await fetch(`${API_URL}?action=getSettings&t=${Date.now()}`);
                const data = await res.json();
                localStorage.setItem('admin_settings', JSON.stringify(data));
                renderSettings(data);
            } catch(e) {}
        }
        function renderSettings(data) {
            let html = '';
            settingsConfig.forEach(f => {
                if(f.type === "header") html += `<div class="settings-section-title">${f.title}</div>`;
                else {
                    let input = f.type === 'textarea' 
                        ? `<textarea id="set_${f.id}" class="w-full theme-input rounded p-2 theme-text border h-16 resize-none outline-none">${data[f.id] || ''}</textarea>`
                        : `<input type="text" id="set_${f.id}" value="${data[f.id] || ''}" class="w-full theme-input rounded p-2 theme-text border outline-none">`;
                    html += `<div class="${f.full ? 'col-span-2' : ''}"><label class="text-[10px] theme-subtext block mb-1">${f.label}</label>${input}</div>`;
                }
            });
            document.getElementById('settingsContainer').innerHTML = html;
        }
        async function saveSettings() {
            const btn = document.getElementById('btnSaveSettings');
            btn.disabled = true;
            let payload = { action: "updateSettings" };
            settingsConfig.forEach(f => { if(f.type !== "header") payload[f.id] = document.getElementById(`set_${f.id}`).value; });
            try {
                await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
                localStorage.setItem('admin_settings', JSON.stringify(payload));
                showToast("Saved!");
                setTimeout(closeSettings, 1000);
            } catch(e) { alert("Failed"); }
            btn.disabled = false;
        }
        function copy(t) { navigator.clipboard.writeText(t); showToast("Copied"); }
        function showToast(m) { const t=document.getElementById('toast'); document.getElementById('toastMsg').innerText=m; t.classList.remove('opacity-0','translate-y-20'); setTimeout(()=>t.classList.add('opacity-0','translate-y-20'), 2000); }
        function closeSettings() { document.getElementById('settingsModal').classList.add('hidden'); document.getElementById('settingsModal').classList.remove('flex'); }
        function openModal(id) { targetId=id; document.getElementById('actionModal').classList.remove('hidden'); document.getElementById('actionModal').classList.add('flex'); }
        function closeModal() { document.getElementById('actionModal').classList.add('hidden'); document.getElementById('actionModal').classList.remove('flex'); }
        function setReason(txt) { document.getElementById('reasonInput').value = txt; }
        function confirmReject() { const r=document.getElementById('reasonInput').value; if(!r){alert("Reason required");return;} performAction(targetId,'Cancelled',r); closeModal(); document.getElementById('reasonInput').value=""; }
        function filterStatus(s) { viewStatus=s; renderView(); }
        function handleSearch() { renderView(); }
    </script>
</body>
</html>